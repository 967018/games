<div id="search_box" class="default">
	<select id="search_mode">
		<option value="title">{{ ui.search_form_mode_title }}</option>
		<option value="tindes">{{ ui.search_form_mode_tindes }}</option>
		<option value="tag">{{ ui.search_form_mode_tag }}</option>
	</select>
	<input id="search_value" />
	<button id="search_do">{{ ui.search_form_do }}</button>
</div>
<div id="search_info" class="default">

</div>
<div class="items">
	<div class="item hide">
		<img class="thumbnail" src="data:," >
		<div class="content">
			<div class="name"><a href="#" class="name_a"></a></div>
			<div class="description"></div>
		</div>
	</div>
	<div style="height: 20px;"></div>
</div>
<div class="default">
{% include 'copying.html' %}
</div>
<script src="{{ rr }}/scripts/base.js"></script>
<script>
const items = $('.items');
const template = $('.item');

const query = window.location.search.substring(1);
const mode = query.substring(0, query.indexOf('?'));
let value = decodeURIComponent(query.substring(query.indexOf('?') + 1));

let getL10n = (game, property) => {
	return (game.tr.hasOwnProperty("{{ lang }}") &&
		game.tr["{{ lang }}"].hasOwnProperty(property)) ?
		game.tr["{{ lang }}"][property] : game[property];
}

let add = (id, game) => {
	const item = template.cloneNode(true);
	item.classList.remove("hide");

	item.querySelector(".thumbnail").src = game.thumbnail;

	const link = item.querySelector(".name_a");
	link.textContent = getL10n(game, "name");
	link.href = "games/" + id + ".html";

	let desc = getL10n(game, "description");
	if (desc.length > 480)
		desc = desc.substr(0, 480) + "...";
	item.querySelector(".description").textContent = desc;

	items.appendChild(item);
}

let onload = async () => {
	$('#search_mode').value = mode;
	$('#search_value').value = value;

	try {
		const searchdb = await (await fetch("{{ rr }}/scripts/searchdb.json")).json();
		const glist = await (await fetch("{{ rr }}/{{ lang }}/gamelist.json")).json();
		const rtag = searchdb.rtag

		switch (mode) {
		case "tag":
			if (rtag.hasOwnProperty(value)) {
				const res = searchdb.rtag[value];
				res.forEach(i => add(i, searchdb.data[i]));
			} else {
				$('.items').textContent = "{{ ui.search_not_found }}";
			}
			break;
		default:
			break;
		}
	} catch (e) {
		alert("{{ ui.search_load_db_error }}");
	}
}

$('#search_do').addEventListener('click', e => {
	window.location.href = "search.html?" + $('#search_mode').value + "?" + $('#search_value').value
});

onload();
</script>
